<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charging Station Dashboard</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTkgXCM1kVRjOEJkJRXA57V4jLe--5b_k&libraries=places&callback=initMap"></script>
    <style>
        /* Background similar to login page */
html, body {
    min-height: 100vh; /* Ensure the entire page can scroll */
    overflow-y: auto; /* Enable vertical scrolling for the whole page */
    margin: 0;
    background: linear-gradient(90deg, #e2e2e2, #c9d6ff);
    font-family: 'Poppins', sans-serif;
    color: white;
}

body {
    display: block; /* Remove flex from body */
}

/* Main Dashboard Container */
.dashboard-container {
    display: flex;
    width: 100%;
    min-height: 100vh;
    background: white;
    border-radius: 0px;
    box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
    /* overflow-y: auto; -- This is now handled by html, body */
}

/* Left Side: Charging Station Details */
.dashboard-left {
    width: 40%;
    background: #7494ec; /* Blue box */
    padding: 50px;
    color: white;
    border-radius: 0px 150px 150px 0px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    text-align: left;
    box-shadow: 0 0 30px rgba(0, 0, 0, .2);
    overflow-y: auto; /* Added scroll for left dashboard content */
}

.dashboard-left h2 {
    margin-bottom: 40px; /* Removed negative margin-top */
    text-align: center;
    font-size: 30px;
}

.dashboard-left p {
    margin: 10px 10px;
    font-size: 16px;
}

/* Right Side: Vehicle List */
.dashboard-right {
    width: 60%;
    padding: 20px;
    background: white(132, 137, 139);
    color: black;
    border-radius: 0 10px 10px 0;
}

.dashboard-right table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.dashboard-right th, .dashboard-right td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.dashboard-right th {
    background-color: #7494ec;
    color: white;
}

/* Buttons Styling */
.addbtn{
    border: 2px solid #fff;
    color: white;
    background: #7494ec;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: none;
    width: 232px;
    height: 40px;
    position: absolute; 
    margin-top: 10px;
    top: 4%;
    left: 81.5%;

}
.btn-container {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center buttons horizontally */
    margin-top: 20px; /* Space from map */
    gap: 15px; /* Space between buttons */
}

.btn {
    border: 2px solid #fff;
    color: white;
    background: transparent;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: none;
    width: 232px;
    height: 40px;
    /* Removed absolute positioning */
}

.btn:hover {
    background-color: #7494ec;
    color: white;
}

.logout-btn {
    /* Removed absolute positioning */
    background-color: white;
    color: #7494ec;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    text-align: center;
    width: 200px;
}

.logout-btn:hover {
    background: darkred;
}


/* Vehicle Modal Styling */
.vehiclemodal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
}

.vehiclemodal-content {
    background-color: white;
    margin: auto;
    padding: 20px;
    width: 40%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 10px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

.close {
    float: right;
    font-size: 24px;
    cursor: pointer;
}

/* Center Modal */

.modal {
    display: flex;
    align-items: center;
    justify-content: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

/* Modal Content */
.modal-content {
    background: white;
    padding: 20px;
    width: 40%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
}

/* Modal Title */
.modal-content h2 {
    margin-bottom: 15px;
    font-size: 20px;
    color: #333;
}

.modal-content label {
    display: block; /* Ensures labels are above inputs */
    font-weight: bold;
    margin-top: 10px;
    text-align: left;
    width: 90%;
    color: #333;
}

/* Form Fields */
.modal-content input {
    width: 90%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
}

/* Save Button */
.save-btn {
    background: #4CAF50;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
}

.save-btn:hover {
    background: #45a049;
}

/* Add these styles to your existing CSS */
.button-group {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.close-btn {
    background: #ff4444;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.close-btn:hover {
    background: #cc0000;
}

/* New styles for Add Vehicle modal alignment and headings */
.vehiclemodal-content h3 {
    text-align: left;
    margin-top: 20px;
    margin-bottom: 10px;
    color: #333;
    font-size: 18px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.vehiclemodal-content .form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 15px;
}

.vehiclemodal-content .form-group label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}


.vehiclemodal-content .form-group input,
.vehiclemodal-content .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box; /* Include padding in width */
}
.chargingCost
{
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
.add-vehicle-btn {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    margin-top: 20px;
}

.invalid-input {
    border: 2px solid red !important;
}

.error-message {
    color: red;
    font-size: 0.85em;
    margin-top: 5px;
    margin-bottom: 10px;
    text-align: left;
    width: 100%;
}

.loading {
    opacity: 0.5;
    pointer-events: none;
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #fff;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .dashboard-container {
        flex-direction: column;
    }
    .dashboard-left, .dashboard-right {
        width: 100%;
        border-radius: 0;
    }
    .dashboard-left {
        padding: 20px;
    }
    .addbtn {
        position: static;
        margin: 10px auto;
    }
}

    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Left: Charging Station Details -->
        <div class="dashboard-left">
            <h2>Welcome,<br> {{ station.name }} <br>Charging Station</h2>
            <p id="operator-display"><strong>Operator:</strong> {{ station.operator }}</p>
            <p id="charging-type-display"><strong>Charging Type:</strong> {{ station.chargingType }}</p>
            <p id="location-display"><strong>Location:</strong> {{ station.location }}</p>
            <p id="total-slots-display"><strong>Total Slots:</strong> {{ station.total_slots }}</p>
            <p id="available-slots-display"><strong>Available Slots:</strong> {{ station.available_slots }}</p>
            <p id="charging-rate-display"><strong>Charging Rate:</strong> ₹{{ station.charging_rate }} per kWh</p>

            <div id="display-map" style="height: 200px; width: 100%; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>

            <div class="btn-container">
                <button onclick="openModal()" class="btn">Update Information</button>
                <a href="/" class=" logout-btn">Logout</a>
            </div>
        </div>

        <!-- Right: List of Vehicles -->
        <div class="dashboard-right">
            <h2>Currently Charging Vehicles</h2>
            <button onclick="openVehicleModal()" class="addbtn">Add Vehicle</button>

            <table>
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Vehicle Number</th>
                        <th>Arrival Time</th>
                        <th>Estimated Departure Time</th>
                        <th>Charging Type</th>
                        <th>Battery Capacity</th>
                        <th>Initial Battery</th>
                        <th>Target Battery</th>
                        <th>Charging Time</th>
                        <th>Wait Time</th>
                        <th>Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr id="vehicle-{{ vehicle.id }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ vehicle.vehicle_number }}</td>
                        <td>{{ vehicle.arrival_time }}</td>
                        <td>{{ vehicle.departure_time }}</td>
                        <td>{{ vehicle.chargingType }}</td>
                        <td>{{ vehicle.battery_capacity }} kWh</td>
                        <td>{{ vehicle.initial_battery_level }}%</td>
                        <td>{{ vehicle.target_battery_level }}%</td>
                        <td>
                            {% if vehicle.charging_time_minutes >= 60 %}
                                {{ (vehicle.charging_time_minutes / 60) | int }} hrs {{ (vehicle.charging_time_minutes % 60) | int }} min
                            {% else %}
                                {{ vehicle.charging_time_minutes }} min
                            {% endif %}
                        </td>
                        <td>{{ vehicle.wait_time_minutes }} min</td>
                        <td>₹{{ vehicle.charging_cost }}</td>
                        <td>
                            <button class="remove-btn" onclick="removeVehicle('{{ vehicle.id }}')">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    

<div id="vehicleModal" class="vehiclemodal" role="dialog" aria-labelledby="vehicleModalTitle">
    <div class="vehiclemodal-content">
        <span class="close" onclick="closeVehicleModal()" aria-label="Close Add Vehicle Modal">&times;</span>
        <h2 id="vehicleModalTitle">Add Vehicle</h2>
        
        <form id="addVehicleForm">
            <h3>Vehicle Details</h3>
            <div class="form-group">
                <label for="vehicleNumber">Vehicle Number:</label>
                <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required>
            </div>

            <h3>Time Information</h3>
            <div class="form-group">
                <label for="arrivalTime">Arrival Time:</label>
                <input type="time" id="arrivalTime" placeholder="Time of arrival" required>
            </div>

            <h3>Charging Details</h3>
            <div class="form-group">
                <label for="vehicleChargingType">Charging Type:</label>
                <select id="vehicleChargingType" required>
                    <option value="">Select Charging Type</option>
                    <option value="AC Type 1">AC Type 1</option>
                    <option value="AC Type 2">AC Type 2</option>
                    <option value="CCS">CCS</option>
                    <option value="CHAdeMO">CHAdeMO</option>
                    <option value="GB/T">GB/T</option>
                </select>
            </div>

            <h3>Battery Details</h3>
            <div class="form-group">
                <label for="batteryCapacity">Battery Capacity (kWh):</label>
                <input type="number" id="batteryCapacity" value="60" min="1" max="200" required>
            </div>
            <div class="form-group">
                <label for="initialBatteryLevel">Initial Battery Level (%):</label>
                <input type="number" id="initialBatteryLevel" min="0" max="100" required>
            </div>
            <div class="form-group">
                <label for="targetBatteryLevel">Target Battery Level (%):</label>
                <input type="number" id="targetBatteryLevel" min="0" max="100" required>
            </div>

            <div class="chargingCost" id="chargingEstimate" style="display: none; margin-top: 15px; ; padding: 10px; background:rgba(0, 0, 0, .2); border-radius: 5px;">
                <h4>Charging Estimates</h4>
                <p>Estimated Time: <span id="estimatedTime">-</span></p>
                <p>Estimated Cost: ₹<span id="estimatedCost">-</span></p>
            </div>

            <button type="submit" class="save-btn add-vehicle-btn" aria-label="Add Vehicle">Add Vehicle</button>
        </form>
    </div>
</div>


        <div id="Modal" class="modal" role="dialog" aria-labelledby="updateModalTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal()" aria-label="Close Update Station Modal">&times;</span>
            <h2 id="updateModalTitle">Update Charging Station Details</h2>
            
            <form id="updateForm">
                <label>Station Name:</label>
                <input type="text" id="stationName" value="{{ station.name }}" placeholder="Station name" required>

                <label>Operator Name:</label>
                <input type="text" id="operatorName" value="{{ station.operator }}" placeholder="operator Name" required>

                <label>Charging Type:</label>
                <select id="stationChargingType" required>
                    <option value="">Select Charging Type</option>
                    <option value="AC Type 1" {% if station.chargingType == 'AC Type 1' %}selected{% endif %}>AC Type 1 (₹15/kWh)</option>
                    <option value="AC Type 2" {% if station.chargingType == 'AC Type 2' %}selected{% endif %}>AC Type 2 (₹18/kWh)</option>
                    <option value="CCS" {% if station.chargingType == 'CCS' %}selected{% endif %}>CCS (₹25/kWh)</option>
                    <option value="CHAdeMO" {% if station.chargingType == 'CHAdeMO' %}selected{% endif %}>CHAdeMO (₹25/kWh)</option>
                    <option value="GB/T" {% if station.chargingType == 'GB/T' %}selected{% endif %}>GB/T (₹20/kWh)</option>
                </select>

                <label>Location:</label>
                <input type="text" id="location" value="{{ station.location }}" placeholder="Location" required>

                <label>Total Slots:</label>
                <input type="number" id="totalSlots" min="1" value="{{ station.total_slots }}" placeholder="Number of slots" required>

                <label>Available Slots:</label>
                <input type="number" id="availableSlots" min="0" value="{{ station.available_slots }}" placeholder="Available slots" required>

                <label>Charging Rate (₹/kWh):</label>
                <input type="number" id="chargingRate" min="1" value="{{ station.charging_rate }}" placeholder="Charging rate" required>

                <label>Location on Map:</label>
                <input id="map-search" type="text" placeholder="Search for location..." style="width:100%;margin-bottom:10px;padding:8px;border-radius:4px;border:1px solid #ccc;">
                <div id="map" style="height: 300px; width: 100%; margin-bottom: 20px; border-radius: 5px;"></div>
                <input type="hidden" id="latitude" name="latitude" value="{{ station.latitude if station.latitude else '' }}">
                <input type="hidden" id="longitude" name="longitude" value="{{ station.longitude if station.longitude else '' }}">

                <div class="button-group">
                    <button type="button" class="close-btn" onclick="closeModal()" aria-label="Close">Close</button>
                    <button type="submit" class="save-btn" aria-label="Save Changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


<script>
    // Track form changes
    let formChanged = false;
    const form = document.getElementById("updateForm");
    let initialFormData = new FormData(form);

    // Add event listeners to all form inputs to track changes
    form.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', () => {
            formChanged = true;
        });
    });

    // Function to update charging rate based on charging type
    function updateChargingRate(selectElement) {
        const chargingRates = {
            'AC Type 1': 15,
            'AC Type 2': 18,
            'CCS': 25,
            'CHAdeMO': 25,
            'GB/T': 20,
            'Tesla Supercharger': 30
        };
        
        const selectedType = selectElement.value;
        const chargingRateInput = document.getElementById('chargingRate');
        if (selectedType && chargingRates[selectedType]) {
            chargingRateInput.value = chargingRates[selectedType];
            formChanged = true;
        } else {
            chargingRateInput.value = ''; // Clear if no type selected or type not found
        }
    }

    // Add event listener for charging type changes
    document.getElementById('stationChargingType').addEventListener('change', function() {
        updateChargingRate(this);
    });

    // Initial call to set rate if a type is already selected (e.g., on page load from existing data)
    document.addEventListener('DOMContentLoaded', function() {
        const stationChargingTypeSelect = document.getElementById('stationChargingType');
        updateChargingRate(stationChargingTypeSelect);
    });

    // Function to check for unsaved changes
    function hasUnsavedChanges() {
        if (!formChanged) return false;
        
        const currentFormData = new FormData(form);
        for (let [key, value] of currentFormData.entries()) {
            if (initialFormData.get(key) !== value) {
                return true;
            }
        }
        return false;
    }

    // Modified closeModal function with confirmation
    function closeModal() {
        if (hasUnsavedChanges()) {
            if (confirm("You have unsaved changes. Are you sure you want to close without saving?")) {
                document.getElementById("Modal").style.display = "none";
                formChanged = false;
            }
        } else {
            document.getElementById("Modal").style.display = "none";
        }
    }

    // Reset form change tracking when modal is opened
    function openModal() {
        document.getElementById("Modal").style.display = "flex";
        formChanged = false;
        // Update initial form data
        initialFormData = new FormData(form);
        trapFocus(document.getElementById("Modal"));
    }

    // Target the save button specifically within the update form
    document.querySelector("#updateForm .save-btn").addEventListener("click", async function(event) {
        event.preventDefault();
        formChanged = false;

        const submitBtn = this; // Reference to the button
        toggleLoadingState(submitBtn, true); // Show loading state

        let stationName = document.getElementById("stationName").value;
        let operatorName = document.getElementById("operatorName").value;
        let chargingType = document.getElementById("stationChargingType").value;
        let location = document.getElementById("location").value;
        let totalSlots = document.getElementById("totalSlots").value;
        let availableSlots = document.getElementById("availableSlots").value;
        let chargingRate = document.getElementById("chargingRate").value;
        let latitude = document.getElementById("latitude").value;
        let longitude = document.getElementById("longitude").value;

        const requestData = {
            stationName: stationName,
            operatorName: operatorName,
            chargingType: chargingType,
            location: location,
            totalSlots: totalSlots,
            availableSlots: availableSlots,
            chargingRate: chargingRate,
            latitude: latitude,
            longitude: longitude
        };

        console.log("Sending station update data:", requestData);  // Debug log

        try {
            const response = await fetch("/update_station", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData)
            });

            console.log("Raw response:", response);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text);
            }
            const data = await response.json();

            console.log("Parsed data:", data);
            if (data.message) {
                // Update the displayed values directly
                document.querySelector(".dashboard-left h2").innerHTML = `Welcome,<br> ${stationName} <br>Charging Station`;
                document.getElementById("operator-display").innerHTML = `<strong>Operator:</strong> ${operatorName}`;
                document.getElementById("charging-type-display").innerHTML = `<strong>Charging Type:</strong> ${chargingType}`;
                document.getElementById("location-display").innerHTML = `<strong>Location:</strong> ${location}`;
                document.getElementById("total-slots-display").innerHTML = `<strong>Total Slots:</strong> ${totalSlots}`;
                document.getElementById("available-slots-display").innerHTML = `<strong>Available Slots:</strong> ${availableSlots}`;
                document.getElementById("charging-rate-display").innerHTML = `<strong>Charging Rate:</strong> ₹${chargingRate} per kWh`;

                // Close the modal
                document.getElementById("Modal").style.display = "none";
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Changes saved successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);

                // Re-initialize the display map to reflect updated coordinates
                if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                    initDisplayMap(); 
                } else {
                    console.warn("Google Maps API not loaded, cannot re-initialize display map.");
                }

            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error("Update Error:", error);
            alert("An error occurred while updating. Please try again." + error.message);
        } finally {
            toggleLoadingState(submitBtn, false); // Hide loading state
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        let updateModal = document.getElementById("Modal");
        let vehicleModal = document.getElementById("vehicleModal");

        if (event.target === updateModal) {
            closeModal();
        }
        if (event.target === vehicleModal) {
            closeVehicleModal();
        }
    };

    // Open the Add Vehicle Modal
    function openVehicleModal() {
        document.getElementById("vehicleModal").style.display = "flex";
        trapFocus(document.getElementById("vehicleModal"));
    }

    // Close the Add Vehicle Modal
    function closeVehicleModal() {
        document.getElementById("vehicleModal").style.display = "none";
    }

    document.getElementById("addVehicleForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const addVehicleBtn = this.querySelector('.add-vehicle-btn'); // Reference to the add vehicle button
        toggleLoadingState(addVehicleBtn, true); // Show loading state

        const vehicleNumberInput = document.getElementById("vehicleNumber");
        const initialBatteryLevelInput = document.getElementById("initialBatteryLevel");
        const targetBatteryLevelInput = document.getElementById("targetBatteryLevel");
        const arrivalTimeInput = document.getElementById("arrivalTime");
        const vehicleChargingTypeInput = document.getElementById("vehicleChargingType");
        const batteryCapacityInput = document.getElementById("batteryCapacity");

        const vehicleNumber = vehicleNumberInput.value.trim();
        const arrivalTime = arrivalTimeInput.value;
        const chargingType = vehicleChargingTypeInput.value;
        const initialBatteryLevel = parseFloat(initialBatteryLevelInput.value);
        const targetBatteryLevel = parseFloat(targetBatteryLevelInput.value);
        const batteryCapacity = parseFloat(batteryCapacityInput.value);

        const vehicleNumberRegex = /^[A-Z]{2}\d{2}[A-Z]{1,2}\d{4}$/;

        // Clear previous error messages and styles
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        vehicleNumberInput.classList.remove('invalid-input');
        initialBatteryLevelInput.classList.remove('invalid-input');
        targetBatteryLevelInput.classList.remove('invalid-input');
        arrivalTimeInput.classList.remove('invalid-input');
        vehicleChargingTypeInput.classList.remove('invalid-input');
        batteryCapacityInput.classList.remove('invalid-input');

        let isValid = true;

        if (!vehicleNumber) {
            displayError(vehicleNumberInput, "Vehicle number is required.");
            isValid = false;
        } else if (!vehicleNumberRegex.test(vehicleNumber)) {
            displayError(vehicleNumberInput, "Invalid vehicle number format (e.g., MH12AB1234)");
            isValid = false;
        }

        if (!arrivalTime) {
            displayError(arrivalTimeInput, "Arrival time is required.");
            isValid = false;
        }

        if (!chargingType) {
            displayError(vehicleChargingTypeInput, "Charging type is required.");
            isValid = false;
        }

        if (isNaN(initialBatteryLevel) || initialBatteryLevel < 0 || initialBatteryLevel > 100) {
            displayError(initialBatteryLevelInput, "Please enter a valid initial battery level (0-100%).");
            isValid = false;
        }

        if (isNaN(targetBatteryLevel) || targetBatteryLevel < 0 || targetBatteryLevel > 100) {
            displayError(targetBatteryLevelInput, "Please enter a valid target battery level (0-100%).");
            isValid = false;
        }

        if (initialBatteryLevel !== undefined && targetBatteryLevel !== undefined && targetBatteryLevel <= initialBatteryLevel) {
            displayError(targetBatteryLevelInput, "Target battery level must be greater than initial battery level.");
            isValid = false;
        }

        if (isNaN(batteryCapacity) || batteryCapacity <= 0) {
            displayError(batteryCapacityInput, "Please enter a valid battery capacity (e.g., 60 kWh).");
            isValid = false;
        }

        if (!isValid) {
            toggleLoadingState(addVehicleBtn, false); // Hide loading state if validation fails
            return; // Stop form submission if validation fails
        }

        const requestData = {
            vehicleNumber: vehicleNumber,
            arrivalTime: arrivalTime,
            chargingType: chargingType,
            initialBatteryLevel: initialBatteryLevel,
            targetBatteryLevel: targetBatteryLevel,
            batteryCapacity: batteryCapacity
        };

        try {
            const response = await fetch("/add_vehicle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData)
            });
            const data = await response.json();

            if (data.message) {
                // Add the new vehicle to the table with charging information
                const tableBody = document.querySelector(".dashboard-right table tbody");
                const newRow = tableBody.insertRow();
                newRow.id = `vehicle-${data.vehicle_id}`;
                
                let chargingTimeDisplay;
                if (data.charging_time_minutes >= 60) {
                    const hours = Math.floor(data.charging_time_minutes / 60);
                    const minutes = data.charging_time_minutes % 60;
                    chargingTimeDisplay = `${hours} hrs ${minutes} min`;
                } else {
                    chargingTimeDisplay = `${data.charging_time_minutes} min`;
                }

                newRow.innerHTML = `
                    <td>${tableBody.rows.length}</td>
                    <td>${vehicleNumber}</td>
                    <td>${arrivalTime}</td>
                    <td>${data.departure_time}</td>
                    <td>${chargingType}</td>
                    <td>${batteryCapacity} kWh</td>
                    <td>${initialBatteryLevel}%</td>
                    <td>${targetBatteryLevel}%</td>
                    <td>${chargingTimeDisplay}</td>
                    <td>${data.wait_time_minutes} min</td>
                    <td>₹${data.charging_cost}</td>
                    <td>
                        <button class="remove-btn" onclick="removeVehicle(\'${data.vehicle_id}\')" aria-label="Remove Vehicle ${vehicleNumber}">Remove</button>
                    </td>
                `;
                // Sort the table after adding a new vehicle
                sortVehicleTableByArrivalTime();
                closeVehicleModal();
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Vehicle added successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);

                // Clear the form
                document.getElementById("addVehicleForm").reset();
                document.getElementById('chargingEstimate').style.display = 'none';
            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error("Add Vehicle Error:", error);
            alert("An error occurred while adding vehicle. Please try again." + error.message);
        } finally {
            toggleLoadingState(addVehicleBtn, false); // Hide loading state
        }
    });

    // Function to remove a vehicle
    async function removeVehicle(vehicleId) {
        if (!confirm("Are you sure you want to remove this vehicle?")) {
            return;
        }

        const removeBtn = document.querySelector(`#vehicle-${vehicleId} .remove-btn`);
        if (removeBtn) {
            toggleLoadingState(removeBtn, true);
        }

        try {
            const response = await fetch("/remove_vehicle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ vehicle_id: vehicleId })
            });
            const data = await response.json();

            if (data.message) {
                const vehicleRow = document.getElementById(`vehicle-${vehicleId}`);
                if (vehicleRow) {
                    console.log(`Attempting to remove row with ID: vehicle-${vehicleId}`); // Debug log
                    vehicleRow.remove(); // Remove the row from the table
                    
                    // Reindex the remaining rows
                    const tableBody = document.querySelector(".dashboard-right table tbody");
                    const rows = tableBody.getElementsByTagName("tr");
                    for (let i = 0; i < rows.length; i++) {
                        rows[i].cells[0].textContent = i + 1; // Update the index cell
                    }
                } else {
                    console.error(`Could not find row with ID: vehicle-${vehicleId}`); // Debug log
                }

                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Vehicle removed successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);

            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error("Remove Vehicle Error:", error);
            alert("An error occurred while removing the vehicle. Please try again." + error.message);
        } finally {
            if (removeBtn) {
                toggleLoadingState(removeBtn, false);
            }
        }
    }

    // This part ensures that if you navigate away with unsaved changes, you get a warning
    window.onbeforeunload = function() {
        if (formChanged) {
            return "You have unsaved changes. Do you want to leave without saving?";
        }
    };

    // Ensure the update modal is hidden when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("Modal").style.display = "none";
        // Debug log (already present) check for google and google.maps
        console.log("DOMContentLoaded: google defined?", typeof google !== 'undefined', "google.maps defined?", typeof google.maps !== 'undefined'); 
    });

    let map, marker;
    let displayMap, displayMarker;

    function initMap() {
        // Default to a central location if station coords not available
        const defaultLat = parseFloat(document.getElementById('latitude').value) || 26.9124;
        const defaultLng = parseFloat(document.getElementById('longitude').value) || 75.7873;
        const initialLocation = { lat: defaultLat, lng: defaultLng };

        map = new google.maps.Map(document.getElementById('map'), {
            center: initialLocation,
            zoom: 12,
            mapTypeControl: false, // Optional: hide map type controls
            streetViewControl: false, // Optional: hide street view control
            fullscreenControl: false, // Optional: hide fullscreen control
        });

        marker = new google.maps.Marker({
            position: initialLocation,
            map: map,
            draggable: true,
            title: "Drag to set location",
        });

        // Update lat/lng inputs when marker is dragged
        marker.addListener('dragend', function() {
            const newPosition = marker.getPosition();
            document.getElementById('latitude').value = newPosition.lat();
            document.getElementById('longitude').value = newPosition.lng();
            formChanged = true; // Mark form as changed

            // Update the display map marker position as well
            if (displayMarker) {
                displayMarker.setPosition(newPosition);
            }
        });

        // Update lat/lng inputs when map is clicked
        map.addListener('click', function(event) {
            marker.setPosition(event.latLng);
            document.getElementById('latitude').value = event.latLng.lat();
            document.getElementById('longitude').value = event.latLng.lng();
            formChanged = true; // Mark form as changed

            // Update the display map marker position as well
            if (displayMarker) {
                displayMarker.setPosition(event.latLng);
            }
        });

        // Re-center map and marker when modal opens
        document.getElementById('Modal').addEventListener('transitionend', function() {
            if (this.style.display === 'flex') { // Check if modal is visible
                google.maps.event.trigger(map, 'resize');
                // Update map center with current station data when modal opens
                const currentLat = parseFloat(document.getElementById('latitude').value) || 26.9124;
                const currentLng = parseFloat(document.getElementById('longitude').value) || 75.7873;
                const currentPosition = { lat: currentLat, lng: currentLng };
                map.setCenter(currentPosition);
                marker.setPosition(currentPosition);
            }
        });
        initDisplayMap(); // Added: Initialize the display map after the main map is ready

        // Add Places Autocomplete search box
        const input = document.getElementById('map-search');
        if (input) {
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert("No details available for input: '" + place.name + "'");
                    return;
                }

                // If the place has a geometry, then present it on a map.
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                marker.setPosition(place.geometry.location);

                // Update hidden latitude/longitude fields
                document.getElementById('latitude').value = place.geometry.location.lat();
                document.getElementById('longitude').value = place.geometry.location.lng();
                formChanged = true;
            });
        }
    }

    // Function to initialize the display map on the dashboard
    function initDisplayMap() {
        const displayMapElement = document.getElementById('display-map');
        if (!displayMapElement) {
            console.error("Display map element not found!");
            return;
        }

        // Use current coordinates from the form fields, not Jinja template
        const stationLat = parseFloat(document.getElementById('latitude').value) || 26.9124;
        const stationLng = parseFloat(document.getElementById('longitude').value) || 75.7873;
        const stationLocation = { lat: stationLat, lng: stationLng };

        // If map exists, just update its center and marker
        if (displayMap) {
            displayMap.setCenter(stationLocation);
            if (displayMarker) {
                displayMarker.setPosition(stationLocation);
            } else {
                displayMarker = new google.maps.Marker({
                    position: stationLocation,
                    map: displayMap,
                    draggable: false,
                    title: "Charging Station Location"
                });
            }
            google.maps.event.trigger(displayMap, 'resize');
            return;
        }

        // Create new map if it doesn't exist
        displayMap = new google.maps.Map(displayMapElement, {
            center: stationLocation,
            zoom: 15,
            disableDefaultUI: true,
            gestureHandling: 'none',
            zoomControl: false
        });

        displayMarker = new google.maps.Marker({
            position: stationLocation,
            map: displayMap,
            draggable: false,
            title: "Charging Station Location"
        });

        google.maps.event.trigger(displayMap, 'resize');
    }

    // Existing openModal function, ensure it calls initMap if map not initialized
    const originalOpenModal = openModal;
    openModal = function() {
        originalOpenModal();
        // Check if google maps API is loaded and the map variable itself is not yet initialized
        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && !map) {
            initMap(); // Initialize map only once if not already
        }
    };

    // Add this to your existing JavaScript
    function updateChargingEstimate() {
        const batteryCapacity = parseFloat(document.getElementById('batteryCapacity').value);
        const initialLevel = parseFloat(document.getElementById('initialBatteryLevel').value);
        const targetLevel = parseFloat(document.getElementById('targetBatteryLevel').value);
        const chargingType = document.getElementById('vehicleChargingType').value;

        const chargingSpeeds = {
            "AC Type 1": 7.4, "AC Type 2": 22.0, "CCS": 150.0, "CHAdeMO": 62.5 , "GB/T": 120.0
        };
        const chargingRates = {
            "AC Type 1": 15, "AC Type 2": 18, "CCS": 25, "CHAdeMO": 25, "GB/T": 20
        };
        const chargingEfficiency = {
            "AC Type 1": 0.85, "AC Type 2": 0.88, "CCS": 0.92, "CHAdeMO": 0.92, "GB/T": 0.90
        };

        if (batteryCapacity && initialLevel && targetLevel && chargingType) {
            // Calculate charging time and cost
            // Apply similar logic as backend to avoid mathematical issues for 100%
            let adjustedTargetLevel = targetLevel;
            let adjustedInitialLevel = initialLevel;

            if (adjustedTargetLevel === 100) {
                adjustedTargetLevel = 99.9; // Adjust target to prevent issues in logistic calculation
            }
            if (adjustedInitialLevel === 0) {
                adjustedInitialLevel = 0.1; // Adjust initial to prevent issues
            }

            const batteryPercentageToCharge = adjustedTargetLevel - adjustedInitialLevel;
            const energyNeededKwh = (batteryPercentageToCharge / 100) * batteryCapacity;

            const chargingSpeed = chargingSpeeds[chargingType] || 7.4;
            const chargingRate = chargingRates[chargingType] || 15;
            const efficiency = chargingEfficiency[chargingType] || 0.85; // Get efficiency based on type

            const chargingTimeHours = energyNeededKwh / chargingSpeed;
            const chargingTimeMinutes = chargingTimeHours * 60;
            const actualEnergyConsumed = energyNeededKwh / efficiency; // Use type-specific efficiency
            const chargingCost = actualEnergyConsumed * chargingRate;

            // Update the estimate display
            let estimatedTimeMinutes = Math.round(chargingTimeMinutes);
            let estimatedTimeDisplay;
            if (estimatedTimeMinutes >= 60) {
                const hours = Math.floor(estimatedTimeMinutes / 60);
                const minutes = estimatedTimeMinutes % 60;
                estimatedTimeDisplay = `${hours} hrs ${minutes} min`;
            } else {
                estimatedTimeDisplay = `${estimatedTimeMinutes} min`;
            }
            document.getElementById('estimatedTime').textContent = estimatedTimeDisplay;
            document.getElementById('estimatedCost').textContent = Math.round(chargingCost);
            document.getElementById('chargingEstimate').style.display = 'block';
        } else {
            document.getElementById('chargingEstimate').style.display = 'none';
        }
    }

    // Add event listeners for real-time updates
    document.getElementById('batteryCapacity').addEventListener('input', updateChargingEstimate);
    document.getElementById('initialBatteryLevel').addEventListener('input', updateChargingEstimate);
    document.getElementById('targetBatteryLevel').addEventListener('input', updateChargingEstimate);
    document.getElementById('vehicleChargingType').addEventListener('change', updateChargingEstimate);

    window.initMap = initMap;

    // Function to sort the vehicle table by arrival time
    function sortVehicleTableByArrivalTime() {
        const tableBody = document.querySelector(".dashboard-right table tbody");
        const rows = Array.from(tableBody.querySelectorAll("tr"));

        rows.sort((a, b) => {
            // Get arrival time as string (e.g., "13:30")
            const timeA = a.cells[2].textContent.trim();
            const timeB = b.cells[2].textContent.trim();

            // Convert to minutes since midnight for comparison
            const [hA, mA] = timeA.split(":").map(Number);
            const [hB, mB] = timeB.split(":").map(Number);
            const minutesA = hA * 60 + mA;
            const minutesB = hB * 60 + mB;

            return minutesA - minutesB;
        });

        // Re-append sorted rows and update index column
        rows.forEach((row, idx) => {
            row.cells[0].textContent = idx + 1;
            tableBody.appendChild(row);
        });
    }

    // Helper function to show/hide loading spinner and disable/enable button
    function toggleLoadingState(button, isLoading) {
        console.log(`toggleLoadingState called for button: ${button.id || button.className}, isLoading: ${isLoading}`);
        if (isLoading) {
            button.classList.add('loading');
            button.setAttribute('disabled', 'true');
            const spinnerSpan = document.createElement('span');
            spinnerSpan.className = 'spinner';
            button.appendChild(spinnerSpan);
        } else {
            button.classList.remove('loading');
            button.removeAttribute('disabled');
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.remove();
            }
        }
    }

    function trapFocus(modal) {
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        modal.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstElement || document.activeElement === modal) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else { // Tab
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            } else if (e.key === 'Escape') {
                // Optionally close modal on Escape key
                if (modal.id === 'vehicleModal') {
                    closeVehicleModal();
                } else if (modal.id === 'Modal') {
                    closeModal();
                }
            }
        });
    }

    document.getElementById("Modal").addEventListener('transitionend', function() {
        if (this.style.display === 'flex') {
            trapFocus(this);
            // Optionally focus the first focusable element when modal opens
            const firstFocusable = this.querySelector('button, [href], input, select, textarea');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }
    });

    document.getElementById("vehicleModal").addEventListener('transitionend', function() {
        if (this.style.display === 'flex') {
            trapFocus(this);
            // Optionally focus the first focusable element when modal opens
            const firstFocusable = this.querySelector('button, [href], input, select, textarea');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }
    });

</script>

</body>
</html>
